<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Inversionista | Bienes Inmuebles Quilichao</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; }
        .bg-gold-600 { background-color: #D4AF37; }
        .text-gold-400 { color: #F0C42F; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b89b3c; }
    </style>
</head>
<body class="text-white">

    <div id="private-dashboard" class="min-h-screen bg-black">
        <div class="flex">
            <aside class="w-64 bg-gray-900 min-h-screen p-6 hidden lg:flex flex-col border-r border-gray-800">
                <div class="flex items-center space-x-2 mb-10">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-gold-400" role="img" aria-labelledby="logoTitle">
                        <title id="logoTitle">Logo de Inversionistas</title>
                        <path d="M12 2L2 7V21H22V7L12 2ZM20 19H4V8.2L12 4.2L20 8.2V19Z" fill="currentColor"/><path d="M11 16H13V19H11V16Z" fill="currentColor"/><path d="M7 16H9V19H7V16Z" fill="currentColor"/><path d="M15 16H17V19H15V16Z" fill="currentColor"/><path d="M7 12H9V14H7V12Z" fill="currentColor"/><path d="M11 12H13V14H11V12Z" fill="currentColor"/><path d="M15 12H17V14H15V12Z" fill="currentColor"/>
                    </svg>
                    <span class="text-lg font-bold">Inversionistas</span>
                </div>
                <nav id="dashboard-nav" class="space-y-2 flex-grow"></nav>
                <button id="logout-btn" class="w-full mt-10 flex items-center justify-center space-x-2 bg-gray-800 hover:bg-red-600 text-gray-300 hover:text-white font-bold py-3 px-4 rounded-lg transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span>Cerrar Sesión</span>
                </button>
            </aside>
            
            <main class="flex-1">
                <header class="lg:hidden bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center sticky top-0 z-40">
                    <span class="text-lg font-bold text-gold-400">Dashboard</span>
                    <button id="dashboard-mobile-menu-btn" aria-controls="dashboard-mobile-menu" aria-expanded="false">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </header>
                <div id="dashboard-mobile-menu" class="hidden lg:hidden bg-gray-900 p-4 border-b border-gray-800">
                    <nav id="dashboard-mobile-nav" class="space-y-2"></nav>
                    <button id="logout-btn-mobile" class="w-full mt-6 flex items-center justify-center space-x-2 bg-gray-800 hover:bg-red-600 text-gray-300 hover:text-white font-bold py-3 px-4 rounded-lg transition">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Cerrar Sesión</span>
                    </button>
                </div>

                <div id="dashboard-content" class="p-4 sm:p-6 md:p-10">
                    </div>
            </main>
        </div>
    </div>

    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- CONFIGURACIÓN DE SUPABASE ---
    const SUPABASE_URL = 'https://cgpioodxsryqfyofjfvy.supabase.co'; // Pega tu URL aquí
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNncGlvb2R4c3J5cWZ5b2ZqZnZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MTY2MjIsImV4cCI6MjA2MzI5MjYyMn0.TB8MmMzMc18hktGiWal_Fjmuq4ptqp7pz3mi0o8LJLY'; // Pega tu Clave Anon aquí
    
    // CORRECCIÓN: Renombramos la constante para evitar el conflicto de nombres
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // --- VERIFICACIÓN DE SESIÓN DE USUARIO ---
    // Usamos la nueva variable 'supabaseClient'
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
    
    if (!session) {
        // Si no hay sesión, redirigir a la página de inicio/login
        window.location.href = 'index.html';
        return;
    }
    const user = session.user;
    
    // --- VARIABLES GLOBALES DE DATOS ---
    let investorData = {
        profile: {},
        investments: [],
        monthlyReturns: []
    };
    let processedData = {}; // Para guardar los datos calculados

    // --- FUNCIONES DE OBTENCIÓN DE DATOS (FETCH) ---
    const fetchUserProfile = async () => {
        // Usamos la nueva variable 'supabaseClient'
        const { data, error } = await supabaseClient
            .from('profiles')
            .select('full_name, phone, email') // Aseguramos que también traiga el email
            .eq('id', user.id)
            .single();
        if (error) console.error('Error fetching profile:', error);
        else investorData.profile = { name: data.full_name, email: data.email, phone: data.phone };
    };

    const fetchInvestments = async () => {
        // Usamos la nueva variable 'supabaseClient'
        const { data, error } = await supabaseClient
            .from('investments')
            .select('*')
            .eq('user_id', user.id)
            .order('investment_date', { ascending: false });
        if (error) console.error('Error fetching investments:', error);
        else investorData.investments = data;
    };

    const fetchMonthlyReturns = async () => {
        // Usamos la nueva variable 'supabaseClient'
        const { data, error } = await supabaseClient
            .from('monthly_returns')
            .select('*')
            .eq('user_id', user.id)
            .order('return_date', { ascending: false });
        if (error) console.error('Error fetching returns:', error);
        else investorData.monthlyReturns = data;
    };
    
    // --- FUNCIONES DE PROCESAMIENTO DE DATOS ---
    const processDataForDashboard = () => {
        // Capital Activo
        const totalInvested = investorData.investments
            .filter(inv => inv.status === 'Activa')
            .reduce((sum, inv) => sum + parseFloat(inv.amount), 0);
        
        // Rendimiento Histórico
        const totalReturn = investorData.monthlyReturns
            .reduce((sum, ret) => sum + parseFloat(ret.return_amount), 0);

        // Rendimiento Último Mes
        const lastMonthReturn = investorData.monthlyReturns.length > 0 ? parseFloat(investorData.monthlyReturns[0].return_amount) : 0;
        
        // Próxima Fecha de Pago
        let nextPaymentDate = "N/A";
        if (investorData.investments.length > 0) {
             const lastActiveInvestment = investorData.investments.find(inv => inv.status === 'Activa');
             if (lastActiveInvestment) {
                const investmentDate = new Date(lastActiveInvestment.investment_date + 'T00:00:00Z'); // Asegurar que es UTC
                
                // Usar la fecha actual para calcular el próximo pago
                const today = new Date();
                let paymentMonth = today.getUTCMonth();
                let paymentYear = today.getUTCFullYear();
                const paymentDay = investmentDate.getUTCDate();
                
                // Si el día de pago de este mes ya pasó, calcular para el próximo mes
                if (today.getUTCDate() > paymentDay) {
                    paymentMonth += 1;
                    if (paymentMonth > 11) {
                        paymentMonth = 0;
                        paymentYear += 1;
                    }
                }
                
                const nextPayment = new Date(Date.UTC(paymentYear, paymentMonth, paymentDay));
                nextPaymentDate = nextPayment.toLocaleDateString('es-ES', { month: 'short', day: '2-digit', year: 'numeric' });
             }
        }

        // Transacciones para el historial
        const investmentTransactions = investorData.investments.map(inv => ({
            date: inv.investment_date,
            description: `Inversión Inicial (ID: ${inv.id})`,
            amount: parseFloat(inv.amount),
            type: 'investment'
        }));
        const returnTransactions = investorData.monthlyReturns.map(ret => ({
            date: ret.return_date,
            description: `Rendimiento Mensual (Inv. ID: ${ret.investment_id})`,
            amount: parseFloat(ret.return_amount),
            type: 'return'
        }));

        const transactions = [...investmentTransactions, ...returnTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));

        processedData = {
            summary: { totalInvested, totalReturn, lastMonthReturn, nextPaymentDate },
            transactions,
            growthChart: { labels: ["Ene", "Feb", "Mar", "Abr", "May", "Jun"], data: [10000, 12000, 11500, 13000, 14000, 15500] },
            portfolioAllocation: { labels: ["Fondo Inmobiliario"], data: [100] }
        };
    };

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount);

    // --- DASHBOARD ELEMENTS ---
    const dashboardNav = document.getElementById('dashboard-nav');
    const dashboardMobileNav = document.getElementById('dashboard-mobile-nav');
    const dashboardContent = document.getElementById('dashboard-content');
    const dashboardMobileMenuBtn = document.getElementById('dashboard-mobile-menu-btn');
    const dashboardMobileMenu = document.getElementById('dashboard-mobile-menu');

    dashboardMobileMenuBtn.addEventListener('click', () => {
        dashboardMobileMenu.classList.toggle('hidden');
        const isExpanded = !dashboardMobileMenu.classList.contains('hidden');
        dashboardMobileMenuBtn.setAttribute('aria-expanded', isExpanded);
    });
    
    // --- NAVEGACIÓN ---
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
        { id: 'investments', label: 'Mis Inversiones', icon: 'trending-up' },
        { id: 'transactions', label: 'Historial', icon: 'history' },
        { id: 'profile', label: 'Mi Perfil', icon: 'user-cog' },
        { id: 'support', label: 'Soporte y Ayuda', icon: 'help-circle' },
    ];
    
    const renderNav = (container) => {
        container.innerHTML = '';
        navItems.forEach(item => {
            const navLink = document.createElement('a');
            navLink.href = '#';
            navLink.dataset.view = item.id;
            navLink.className = 'nav-link flex items-center space-x-3 text-gray-400 p-3 rounded-lg hover:bg-gray-800 hover:text-white transition cursor-pointer';
            navLink.innerHTML = `<i data-lucide="${item.icon}" class="w-5 h-5"></i><span>${item.label}</span>`;
            container.appendChild(navLink);
        });
    };
    
    const handleNavClick = (e) => {
        e.preventDefault();
        const link = e.target.closest('.nav-link');
        if (link) {
            const view = link.dataset.view;
            renderDashboardView(view);
            if(dashboardMobileMenu.contains(link)){
                dashboardMobileMenu.classList.add('hidden');
                dashboardMobileMenuBtn.setAttribute('aria-expanded', 'false');
            }
        }
    };

    // --- CERRAR SESIÓN ---
    const handleLogout = async () => {
        // Usamos la nueva variable 'supabaseClient'
        await supabaseClient.auth.signOut();
        window.location.href = 'index.html';
    };

    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('logout-btn-mobile').addEventListener('click', handleLogout);

    dashboardNav.addEventListener('click', handleNavClick);
    dashboardMobileNav.addEventListener('click', handleNavClick);

    let growthChartInstance = null;
    let allocationChartInstance = null;
    
    // --- RENDERIZADO DE VISTAS ---
    const renderDashboardView = (viewId) => {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('bg-gold-600', 'text-black', 'font-bold');
            link.classList.add('text-gray-400');
            if (link.dataset.view === viewId) {
                link.classList.add('bg-gold-600', 'text-black', 'font-bold');
                link.classList.remove('text-gray-400');
            }
        });

        if (growthChartInstance) growthChartInstance.destroy();
        if (allocationChartInstance) allocationChartInstance.destroy();
        growthChartInstance = null;
        allocationChartInstance = null;

        switch(viewId) {
            case 'dashboard':
                dashboardContent.innerHTML = `
                    <h1 class="text-2xl sm:text-3xl font-bold mb-2">Hola, ${investorData.profile.name}</h1>
                    <p class="text-gray-400 mb-8">Aquí tienes un resumen de tu portafolio de inversiones.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                        <div class="bg-gray-900 p-4 sm:p-6 rounded-lg border border-gray-800"><h4 class="text-gray-400 text-sm mb-2">Capital Activo</h4><p class="text-2xl sm:text-3xl font-bold text-white">${formatCurrency(processedData.summary.totalInvested)}</p></div>
                        <div class="bg-gray-900 p-4 sm:p-6 rounded-lg border border-gray-800"><h4 class="text-gray-400 text-sm mb-2">Rendimiento Histórico</h4><p class="text-2xl sm:text-3xl font-bold text-green-400">${formatCurrency(processedData.summary.totalReturn)}</p></div>
                        <div class="bg-gray-900 p-4 sm:p-6 rounded-lg border border-gray-800"><h4 class="text-gray-400 text-sm mb-2">Rendimiento Último Mes</h4><p class="text-2xl sm:text-3xl font-bold text-gold-400">${formatCurrency(processedData.summary.lastMonthReturn)}</p></div>
                        <div class="bg-gray-900 p-4 sm:p-6 rounded-lg border border-gray-800"><h4 class="text-gray-400 text-sm mb-2">Próxima Fecha de Pago</h4><p class="text-2xl sm:text-3xl font-bold text-white">${processedData.summary.nextPaymentDate}</p></div>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <div class="bg-gray-900 p-4 sm:p-6 rounded-lg border border-gray-800 min-h-[300px] sm:min-h-[400px]"><canvas id="growthChart"></canvas></div>
                        <div class="bg-gray-900 p-4 sm:p-6 rounded-lg border border-gray-800 min-h-[300px] sm:min-h-[400px]"><canvas id="allocationChart"></canvas></div>
                    </div>`;
                
                const growthCtx = document.getElementById('growthChart').getContext('2d');
                growthChartInstance = new Chart(growthCtx, { type: 'line', data: { labels: processedData.growthChart.labels, datasets: [{ label: 'Capital + Rendimientos', data: processedData.growthChart.data, backgroundColor: 'rgba(212, 175, 55, 0.2)', borderColor: '#D4AF37', borderWidth: 2, fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
                
                const allocationCtx = document.getElementById('allocationChart').getContext('2d');
                allocationChartInstance = new Chart(allocationCtx, { type: 'doughnut', data: { labels: processedData.portfolioAllocation.labels, datasets: [{ data: processedData.portfolioAllocation.data, backgroundColor: ['#D4AF37', '#6b7280', '#c084fc'], borderColor: '#111827', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Asignación del Portafolio', color: '#d1d5db', font: { size: 16 } }, legend: { position: 'bottom', labels: { color: '#d1d5db' } } } } });
                break;
            case 'investments':
                dashboardContent.innerHTML = `
                    <h1 class="text-2xl sm:text-3xl font-bold mb-8">Mis Inversiones</h1>
                    <div class="space-y-6">
                        ${investorData.investments.map(inv => {
                            const contractPublicURL = `${SUPABASE_URL}/storage/v1/object/public/contracts/${inv.contract_url}`;
                            return `
                            <div class="bg-gray-900 rounded-lg border border-gray-800 p-4 sm:p-6">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-gold-400">${formatCurrency(inv.amount)}</h3>
                                        <p class="text-sm text-gray-400 font-mono">ID: INV-00${inv.id}</p>
                                    </div>
                                    <span class="text-xs font-semibold px-2 py-1 rounded-full mt-2 sm:mt-0 self-start ${inv.status === 'Activa' ? 'bg-green-500/20 text-green-400' : 'bg-gray-700 text-gray-300'}">${inv.status}</span>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm border-t border-gray-800 pt-4">
                                    <div><p class="text-gray-500">Fecha de Inicio</p><p class="font-semibold">${new Date(inv.investment_date + 'T00:00:00Z').toLocaleDateString('es-ES')}</p></div>
                                    <div><p class="text-gray-500">Tasa de Retorno</p><p class="font-semibold">${(inv.return_rate * 100).toFixed(1)}% Mensual</p></div>
                                    <div class="col-span-2 md:col-span-1">
                                        <a href="${contractPublicURL}" target="_blank" download class="w-full text-center mt-2 md:mt-0 bg-gray-700 hover:bg-gold-600 hover:text-black transition-colors rounded-md px-4 py-2 flex items-center justify-center space-x-2 text-sm"><i data-lucide="download" class="w-4 h-4"></i><span>Descargar Contrato</span></a>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>`;
                break;
            case 'transactions':
                dashboardContent.innerHTML = `
                    <h1 class="text-2xl sm:text-3xl font-bold mb-8">Historial de Transacciones</h1>
                      <div class="space-y-4">
                        ${processedData.transactions.map(t => {
                            const isPositive = t.type === 'investment' || t.type === 'return';
                            return `
                            <div class="bg-gray-900 p-4 rounded-lg border border-gray-800 flex justify-between items-center">
                                <div>
                                    <p class="font-semibold">${t.description}</p>
                                    <p class="text-sm text-gray-400">${new Date(t.date + 'T00:00:00Z').toLocaleDateString('es-ES')}</p>
                                </div>
                                <p class="font-semibold text-right text-base whitespace-nowrap ml-2 ${isPositive ? 'text-green-400' : 'text-red-400'}">
                                    ${isPositive ? '+' : ''} ${formatCurrency(t.amount)}
                                </p>
                            </div>`;
                        }).join('')}
                    </div>`;
                break;
            case 'profile':
                dashboardContent.innerHTML = `
                    <h1 class="text-2xl sm:text-3xl font-bold mb-8">Mi Perfil</h1>
                    <div id="profile-feedback" class="mb-4"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-900 p-6 sm:p-8 rounded-lg border border-gray-800">
                            <h3 class="text-xl font-bold mb-6 text-gold-400">Información Personal</h3>
                            <form id="profile-form" class="space-y-4">
                                <div><label class="block text-sm text-gray-400 mb-1">Nombre Completo</label><input type="text" id="profile-name" value="${investorData.profile.name || ''}" class="w-full bg-gray-800 border border-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold-500"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Correo Electrónico</label><input type="email" value="${investorData.profile.email}" class="w-full bg-gray-700 border border-gray-600 p-3 rounded-lg" disabled></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Número de Teléfono</label><input type="text" id="profile-phone" value="${investorData.profile.phone || ''}" class="w-full bg-gray-800 border border-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold-500"></div>
                                <button type="submit" class="w-full mt-4 bg-gold-600 hover:bg-opacity-90 text-black font-bold py-3 rounded-lg">Guardar Cambios</button>
                            </form>
                        </div>
                        <div class="bg-gray-900 p-6 sm:p-8 rounded-lg border border-gray-800">
                            <h3 class="text-xl font-bold mb-6 text-gold-400">Cambiar Contraseña</h3>
                            <form id="password-form" class="space-y-4">
                                <div><label class="block text-sm text-gray-400 mb-1">Nueva Contraseña</label><input type="password" id="new-password" required class="w-full bg-gray-800 border border-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold-500"></div>
                                <div><label class="block text-sm text-gray-400 mb-1">Confirmar Nueva Contraseña</label><input type="password" id="confirm-password" required class="w-full bg-gray-800 border border-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold-500"></div>
                                <button type="submit" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg">Actualizar Contraseña</button>
                            </form>
                        </div>
                    </div>`;
                
                document.getElementById('profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const feedbackEl = document.getElementById('profile-feedback');
                    const fullName = document.getElementById('profile-name').value;
                    const phone = document.getElementById('profile-phone').value;
                    // Usamos la nueva variable 'supabaseClient'
                    const { error } = await supabaseClient.from('profiles').update({ full_name: fullName, phone: phone }).eq('id', user.id);
                    if (error) {
                       feedbackEl.innerHTML = `<div class="bg-red-900 p-3 rounded-md">${error.message}</div>`;
                    } else {
                       feedbackEl.innerHTML = `<div class="bg-green-900 p-3 rounded-md">¡Perfil actualizado correctamente!</div>`;
                       investorData.profile.name = fullName;
                       investorData.profile.phone = phone;
                    }
                });

                document.getElementById('password-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const feedbackEl = document.getElementById('profile-feedback');
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    if (newPassword.length < 6) {
                       feedbackEl.innerHTML = `<div class="bg-red-900 p-3 rounded-md">La contraseña debe tener al menos 6 caracteres.</div>`;
                       return;
                    }
                    if (newPassword !== confirmPassword) {
                        feedbackEl.innerHTML = `<div class="bg-red-900 p-3 rounded-md">Las contraseñas no coinciden.</div>`;
                        return;
                    }

                    // Usamos la nueva variable 'supabaseClient'
                    const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
                    if (error) {
                       feedbackEl.innerHTML = `<div class="bg-red-900 p-3 rounded-md">${error.message}</div>`;
                    } else {
                       feedbackEl.innerHTML = `<div class="bg-green-900 p-3 rounded-md">¡Contraseña actualizada correctamente!</div>`;
                       e.target.reset();
                    }
                });
                break;
            case 'support':
                dashboardContent.innerHTML = `
                    <h1 class="text-2xl sm:text-3xl font-bold mb-8">Soporte y Ayuda</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold mb-6 text-gold-400">Preguntas Frecuentes (FAQ)</h3>
                            <div class="space-y-4">
                                <details class="bg-gray-900 p-4 rounded-lg border border-gray-800 cursor-pointer"><summary class="font-semibold">¿Cómo se calcula mi rendimiento?</summary><p class="text-gray-400 mt-2">Tu rendimiento se calcula aplicando la tasa mensual sobre tu capital total invertido activo al final de cada mes.</p></details>
                                <details class="bg-gray-900 p-4 rounded-lg border border-gray-800 cursor-pointer"><summary class="font-semibold">¿Cuándo recibiré mis pagos?</summary><p class="text-gray-400 mt-2">Los pagos de rendimientos se procesan y se reflejan en tu cuenta durante los primeros 5 días hábiles de cada mes.</p></details>
                                <details class="bg-gray-900 p-4 rounded-lg border border-gray-800 cursor-pointer"><summary class="font-semibold">¿Puedo retirar mi capital invertido?</summary><p class="text-gray-400 mt-2">El retiro del capital está sujeto a los términos y condiciones especificados en tu contrato de inversión. Por favor, consulta tu documento o contáctanos para más detalles.</p></details>
                            </div>
                        </div>
                        <div class="bg-gray-900 p-6 sm:p-8 rounded-lg border border-gray-800">
                            <h3 class="text-xl font-bold mb-6 text-gold-400">Contacto Directo</h3>
                            <p class="text-gray-400 mb-4">¿Tienes una duda sobre tu inversión? Envíanos un mensaje y te responderemos a la brevedad.</p>
                            <form id="support-form" class="space-y-4">
                                <textarea id="whatsapp-message" placeholder="Escribe tu consulta aquí..." rows="5" class="w-full bg-gray-800 border border-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold-500"></textarea>
                                <button type="submit" class="w-full bg-gold-600 hover:bg-opacity-90 text-black font-bold py-3 rounded-lg">Enviar Consulta por WhatsApp</button>
                            </form>
                        </div>
                    </div>`;
                
                document.getElementById('support-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const numeroWhatsapp = '573177899577'; // <-- CAMBIA ESTE NÚMERO por el tuyo (código de país + número)
                    const message = document.getElementById('whatsapp-message').value;
                    const whatsappURL = `https://wa.me/${numeroWhatsapp}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappURL, '_blank');
                    e.target.reset();
                });
                break;
        }
        lucide.createIcons();
    };
    
    // --- INICIALIZACIÓN ---
    async function initializeDashboard() {
        // Mostrar un estado de carga
        dashboardContent.innerHTML = `<p>Cargando datos del inversionista...</p>`;
        
        // Cargar todos los datos en paralelo
        await Promise.all([
            fetchUserProfile(),
            fetchInvestments(),
            fetchMonthlyReturns()
        ]);
        
        // Procesar los datos una vez cargados
        processDataForDashboard();
        
        // Renderizar la navegación y la vista inicial
        renderNav(dashboardNav);
        renderNav(dashboardMobileNav);
        renderDashboardView('dashboard');
    }

    initializeDashboard();
});
</script>
</body>
</html>